<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Calendario | EvolvP</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: system-ui, sans-serif; }
        html, body { height: 100%; overflow: hidden; }
        body { background: #f4f6f8; }

        /* ---------- TOP BAR ---------- */
        .top-bar {
            height: 120px;
            background: linear-gradient(135deg, #4CAF50, #66bb6a);
            color: white;
            padding: 18px;
            border-radius: 0 0 24px 24px;
            box-shadow: 0 6px 20px rgba(0,0,0,.2);
        }
        .top-title { text-align: center; font-size: 22px; font-weight: 800; }
        .top-date { text-align: center; margin-top: 6px; font-size: 14px; opacity: .9; }

        /* ---------- CALENDAR ---------- */
        .calendar-container {
            height: calc(100% - 120px - 84px);
            padding: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .calendar { width: 100%; max-width: 360px; }
        .weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            text-align: center;
            font-size: 12px;
            margin-bottom: 10px;
            color: #666;
        }
        .days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; }
        .day {
            width: 42px;
            height: 42px;
            margin: auto;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            background: white;
            cursor: pointer;
            position: relative;
            transition: all 0.2s ease;
        }
        
        /* El día seleccionado por el usuario (Color Negro) */
        .day.selected { background: #000 !important; color: white !important; transform: scale(1.1); z-index: 5; }
        
        /* El día completado automáticamente (Meta 65%) */
        .day.completed { background: #4CAF50; color: white; }
        
        /* El anillo del día actual */
        .day.today::after {
            content: "";
            position: absolute;
            inset: -4px;
            border-radius: 50%;
            border: 2px solid #4CAF50;
        }

        .loading-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        /* ---------- BOTTOM BAR ---------- */
        .bottom-bar {
            height: 84px;
            position: fixed;
            bottom: 0; left: 0; right: 0;
            background: rgba(255, 255, 255, .95);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 -6px 20px rgba(0, 0, 0, .15);
        }
        .bottom-bar a { color: #888; font-size: 22px; text-decoration: none; }
        .bottom-bar a.active { color: #4CAF50; }
    </style>
</head>
<body>

<div id="loader" class="loading-overlay">
    <i class="fas fa-circle-notch fa-spin text-green-500 text-3xl"></i>
</div>

<div class="top-bar">
    <div class="top-title">Calendario</div>
    <div class="top-date" id="fullDate"></div>
</div>

<div class="calendar-container">
    <div class="calendar">
        <div class="weekdays">
            <div>L</div><div>M</div><div>X</div><div>J</div><div>V</div><div>S</div><div>D</div>
        </div>
        <div class="days" id="days"></div>
    </div>
    <div id="day-detail" style="margin-top: 30px; text-align: center; width: 100%;">
        <p id="detail-date" class="font-bold text-slate-800"></p>
        <p id="detail-status" class="text-sm text-slate-500"></p>
    </div>
</div>

<div class="bottom-bar">
    <a href="index.html"><i class="fas fa-house"></i></a>
    <a href="Calendario.html" class="active"><i class="fas fa-calendar"></i></a>
    <a href="HabitoHN.html"><i class="fas fa-check"></i></a>
    <a href="Consejos.html"><i class="fas fa-lightbulb"></i></a>
    <a href="AddH.html"><i class="fas fa-plus"></i></a>
    <a href="Ajustes.html"><i class="fas fa-gear"></i></a>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = JSON.parse(__firebase_config);
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'evolvp-app';

    const today = new Date();
    const year = today.getFullYear();
    const month = today.getMonth();
    const todayNumber = today.getDate();

    let userId = null;
    let globalData = { habits: [], logs: {} };
    let selectedDayNum = todayNumber;

    document.getElementById("fullDate").innerText = today.toLocaleDateString("es-ES", { month: "long", year: "numeric" });

    // --- AUTENTICACIÓN ---
    const initAuth = async () => {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
            await signInWithCustomToken(auth, __initial_auth_token);
        } else {
            await signInAnonymously(auth);
        }
    };

    onAuthStateChanged(auth, (user) => {
        if (user) {
            userId = user.uid;
            listenToHabits();
        }
    });

    // --- ESCUCHAR DATOS (HÁBITOS Y LOGS) ---
    function listenToHabits() {
        if (!userId) return;
        // Escuchamos el mismo documento que usa HabitoHN.html
        const docRef = doc(db, 'artifacts', appId, 'users', userId, 'settings', 'habitsMain');

        onSnapshot(docRef, (docSnap) => {
            if (docSnap.exists()) {
                globalData = docSnap.data();
            }
            renderCalendar();
            updateDetail();
            document.getElementById('loader').style.display = 'none';
        }, (error) => {
            console.error("Error sync:", error);
        });
    }

    // --- RENDERIZADO ---
    function renderCalendar() {
        const daysContainer = document.getElementById("days");
        daysContainer.innerHTML = "";

        const firstDay = new Date(year, month, 1).getDay() || 7;
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        // Espacios iniciales
        for (let i = 1; i < firstDay; i++) {
            daysContainer.innerHTML += `<div></div>`;
        }

        const habits = globalData.habits || [];

        for (let d = 1; d <= daysInMonth; d++) {
            const div = document.createElement("div");
            div.classList.add("day");
            div.innerText = d;

            // Formato de fecha para buscar en logs: YYYY-MM-DD
            const dObj = new Date(year, month, d);
            const dateKey = dObj.toISOString().split('T')[0];
            
            // 1. Verificar si es HOY (Anillo verde)
            if (d === todayNumber && month === today.getMonth() && year === today.getFullYear()) {
                div.classList.add("today");
            }

            // 2. Lógica de Completado AUTOMÁTICO (Meta 65%)
            if (habits.length > 0) {
                const dayLog = globalData.logs?.[dateKey] || {};
                const doneCount = habits.filter(h => dayLog[h.id]).length;
                const perc = (doneCount / habits.length) * 100;
                
                if (perc >= 65) {
                    div.classList.add("completed");
                }
            }

            // 3. Selección manual (Color Negro)
            if (d === selectedDayNum) {
                div.classList.add("selected");
            }

            div.onclick = () => {
                selectedDayNum = d;
                renderCalendar();
                updateDetail();
            };

            daysContainer.appendChild(div);
        }
    }

    function updateDetail() {
        const detailDate = document.getElementById("detail-date");
        const detailStatus = document.getElementById("detail-status");
        
        const dObj = new Date(year, month, selectedDayNum);
        const dateKey = dObj.toISOString().split('T')[0];
        const habits = globalData.habits || [];
        const dayLog = globalData.logs?.[dateKey] || {};
        
        detailDate.innerText = dObj.toLocaleDateString("es-ES", { day: 'numeric', month: 'long' });
        
        if (habits.length === 0) {
            detailStatus.innerText = "No hay hábitos configurados.";
            return;
        }

        const doneCount = habits.filter(h => dayLog[h.id]).length;
        const perc = Math.round((doneCount / habits.length) * 100);
        
        detailStatus.innerText = `${perc}% completado (${doneCount}/${habits.length})`;
    }

    initAuth();
</script>

</body>
</html>
