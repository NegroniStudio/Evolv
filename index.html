<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>EvolvP - Inicio</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <!-- Librerías -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

    <style>
        :root {
            --primary: #4CAF50;
            --bg: #f4f6f8;
            --card: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        * {
            margin: 0; padding: 0; box-sizing: border-box;
            font-family: 'Segoe UI', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body { background: var(--bg); color: var(--text-main); height: 100vh; overflow: hidden; }

        /* ---------- TOP BAR ---------- */
        .top-bar {
            height: 180px;
            background: linear-gradient(135deg, #4CAF50, #66bb6a);
            color: white;
            padding: 20px;
            border-radius: 0 0 30px 30px;
            box-shadow: var(--shadow);
            position: relative;
        }

        .header-actions { display: flex; justify-content: space-between; align-items: center; }
        .app-name { font-size: 24px; font-weight: 800; }
        .date-text { text-align: center; margin-top: 10px; font-size: 15px; opacity: 0.9; text-transform: capitalize; }

        .stats-grid {
            display: grid; grid-template-columns: 1fr 1fr;
            gap: 15px; margin-top: 20px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            padding: 10px; border-radius: 15px;
            display: flex; align-items: center; justify-content: center;
            gap: 10px; border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .stat-card i { font-size: 20px; }
        .stat-card span { font-weight: 700; font-size: 20px; }

        /* ---------- MAIN CONTENT ---------- */
        .main {
            height: calc(100% - 180px - 84px);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center; padding: 20px;
        }

        .chart-container {
            background: var(--card);
            padding: 20px; border-radius: 30px;
            box-shadow: var(--shadow);
            width: 100%; max-width: 350px;
            aspect-ratio: 1;
            display: flex; align-items: center; justify-content: center;
        }

        /* ---------- BOTTOM BAR ---------- */
        .bottom-bar {
            height: 84px; position: fixed; bottom: 0; left: 0; right: 0;
            background: white; display: flex;
            justify-content: space-around; align-items: center;
            box-shadow: 0 -5px 15px rgba(0,0,0,0.05);
        }

        .bottom-bar a { color: #888; font-size: 22px; text-decoration: none; padding: 10px; }
        .bottom-bar a.active { color: var(--primary); }
    </style>
</head>
<body>

<div class="top-bar">
    <div class="header-actions">
        <i class="fas fa-bars"></i>
        <div class="app-name">EvolvP</div>
        <i class="fas fa-user-circle"></i>
    </div>
    <div class="date-text" id="dateDisplay"></div>
    <div class="stats-grid">
        <div class="stat-card">
            <i class="fas fa-fire"></i>
            <span id="streakDisplay">0</span>
        </div>
        <div class="stat-card">
            <i class="fas fa-check-circle"></i>
            <span id="totalDoneDisplay">0</span>
        </div>
    </div>
</div>

<div class="main">
    <div class="chart-container">
        <canvas id="habitChart"></canvas>
    </div>
    <p style="margin-top:15px; color:var(--text-muted); font-size:13px;">Progreso por Categoría (Hoy)</p>
</div>

<div class="bottom-bar">
    <a href="index.html" class="active"><i class="fas fa-house"></i></a>
    <a href="Calendario.html"><i class="fas fa-calendar"></i></a>
    <a href="HabitoHN.html"><i class="fas fa-check"></i></a>
    <a href="Consejos.html"><i class="fas fa-lightbulb"></i></a>
    <a href="AddH.html"><i class="fas fa-plus"></i></a>
    <a href="Ajustes.html"><i class="fas fa-gear"></i></a>
</div>

<script>
    // --- 1. GESTIÓN DE DATOS (LOCALSTORAGE) ---
    // Esta función debe estar en todas tus páginas para leer la info compartida
    function getAppData() {
        const data = localStorage.getItem('evolvp_data');
        if (!data) {
            // Datos iniciales de ejemplo si la racha está vacía
            return {
                habitos: [
                    { nombre: "Correr", categoria: "Ejercicio" },
                    { nombre: "Meditar", categoria: "Salud" },
                    { nombre: "Leer", categoria: "Estudio" }
                ],
                completados: {}, // Formato: {"2023-10-27": ["Correr", "Meditar"]}
                config: { rachaMinima: 0.65 } 
            };
        }
        return JSON.parse(data);
    }

    // --- 2. CÁLCULO DE RACHAS Y TOTALES ---
    function calculateStats() {
        const data = getAppData();
        const hoy = new Date().toISOString().split('T')[0];
        
        // Días totales completados (Cualquier día que tenga algo marcado)
        const totalDias = Object.keys(data.completados).length;
        document.getElementById('totalDoneDisplay').innerText = totalDias;

        // Cálculo de Racha Consecutiva
        let streak = 0;
        let curr = new Date();
        
        while (true) {
            const dateStr = curr.toISOString().split('T')[0];
            const realizados = data.completados[dateStr] || [];
            const totalHabitos = data.habitos.length;
            
            // Si el porcentaje del día es mayor al configurado (ej 65%)
            if (totalHabitos > 0 && (realizados.length / totalHabitos) >= data.config.rachaMinima) {
                streak++;
                curr.setDate(curr.getDate() - 1);
            } else {
                // Si es hoy y aún no completamos, no rompemos racha todavía, pero paramos de contar hacia atrás
                if (dateStr === hoy) {
                    curr.setDate(curr.getDate() - 1);
                    continue; 
                }
                break;
            }
        }
        document.getElementById('streakDisplay').innerText = streak;
    }

    // --- 3. GRÁFICO DE ARAÑA DINÁMICO ---
    function renderChart() {
        const data = getAppData();
        const hoy = new Date().toISOString().split('T')[0];
        const hechosHoy = data.completados[hoy] || [];

        // Agrupar hábitos por categoría
        const categorias = [...new Set(data.habitos.map(h => h.categoria))];
        const valores = categorias.map(cat => {
            const habitosDeCat = data.habitos.filter(h => h.categoria === cat);
            const completadosDeCat = habitosDeCat.filter(h => hechosHoy.includes(h.nombre));
            // Valor de 0 a 5 para el gráfico
            return habitosDeCat.length > 0 ? (completadosDeCat.length / habitosDeCat.length) * 5 : 0;
        });

        const ctx = document.getElementById('habitChart').getContext('2d');
        new Chart(ctx, {
            type: 'radar',
            data: {
                labels: categorias,
                datasets: [{
                    data: valores,
                    backgroundColor: 'rgba(76, 175, 80, 0.2)',
                    borderColor: '#4CAF50',
                    borderWidth: 3,
                    pointBackgroundColor: '#4CAF50'
                }]
            },
            options: {
                scales: { r: { min: 0, max: 5, ticks: { display: false } } },
                plugins: { legend: { display: false } }
            }
        });
    }

    // Inicialización
    window.onload = () => {
        document.getElementById("dateDisplay").innerText = new Date().toLocaleDateString("es-ES", {weekday:"long", day:"numeric", month:"long"});
        calculateStats();
        renderChart();
    };
</script>
</body>
</html>
